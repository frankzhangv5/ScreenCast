# ğŸ—ï¸ æ¶æ„è®¾è®¡

## ğŸ¯ æ¶æ„æ¦‚è¿°

ScreenCast é‡‡ç”¨æ¨¡å—åŒ–ã€æ’ä»¶åŒ–çš„æ¶æ„è®¾è®¡ï¼Œç¡®ä¿ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€å¯ç»´æŠ¤æ€§å’Œé«˜æ€§èƒ½ã€‚æ•´ä¸ªç³»ç»Ÿåˆ†ä¸ºæ ¸å¿ƒå±‚ã€è®¾å¤‡å±‚ã€ç•Œé¢å±‚å’Œå·¥å…·å±‚å››ä¸ªä¸»è¦å±‚æ¬¡ã€‚

## ğŸ›ï¸ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç•Œé¢å±‚ (UI Layer)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸»çª—å£  â”‚  è®¾å¤‡åˆ—è¡¨  â”‚  æŠ•å±çª—å£  â”‚  è®¾ç½®çª—å£  â”‚  ç³»ç»Ÿæ‰˜ç›˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        è®¾å¤‡å±‚ (Device Layer)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è®¾å¤‡ç®¡ç†å™¨  â”‚  Androidè®¾å¤‡  â”‚  OHOSè®¾å¤‡  â”‚  è®¾å¤‡è¿æ¥å™¨      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        æ ¸å¿ƒå±‚ (Core Layer)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é…ç½®ç®¡ç†  â”‚  æµè§£ç å™¨  â”‚  æµè¯»å–å™¨  â”‚  æ—¥å¿—ç³»ç»Ÿ            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        å·¥å…·å±‚ (Util Layer)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å·¥å…·å‡½æ•°  â”‚  å¸¸é‡å®šä¹‰  â”‚  ç±»å‹å®šä¹‰  â”‚  é”™è¯¯å¤„ç†            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æ ¸å¿ƒæ¨¡å—

### é…ç½®ç®¡ç† (Settings)
è´Ÿè´£åº”ç”¨ç¨‹åºçš„é…ç½®ç®¡ç†ï¼ŒåŒ…æ‹¬ç”¨æˆ·è®¾ç½®ã€ç³»ç»Ÿé…ç½®ç­‰ã€‚

```cpp
class Settings : public QObject
{
    Q_OBJECT

public:
    static Settings* instance();
    
    // é…ç½®è¯»å†™
    QVariant getValue(const QString& key, const QVariant& defaultValue = QVariant());
    void setValue(const QString& key, const QVariant& value);
    
    // é…ç½®é‡ç½®
    void resetToDefault();
    
private:
    Settings();
    void loadSettings();
    void saveSettings();
    
    QSettings* m_settings;
};
```

### æµè§£ç å™¨ (StreamDecoder)
è´Ÿè´£è§†é¢‘æµçš„è§£ç å’Œå¤„ç†ï¼Œæ”¯æŒå¤šç§ç¼–ç æ ¼å¼ã€‚

```cpp
class StreamDecoder : public QObject
{
    Q_OBJECT

public:
    explicit StreamDecoder(QObject* parent = nullptr);
    ~StreamDecoder();
    
    // è§£ç æ§åˆ¶
    bool startDecode(const QString& deviceId);
    void stopDecode();
    
    // å¸§å¤„ç†
    void processFrame(const QByteArray& frameData);
    
signals:
    void frameReady(const QImage& frame);
    void decodeError(const QString& error);
    
private:
    void initializeCodec();
    void cleanupCodec();
    
    AVCodecContext* m_codecContext;
    SwsContext* m_swsContext;
};
```

### æµè¯»å–å™¨ (StreamReader)
è´Ÿè´£ä»è®¾å¤‡è¯»å–è§†é¢‘æµæ•°æ®ã€‚

```cpp
class StreamReader : public QObject
{
    Q_OBJECT

public:
    explicit StreamReader(QObject* parent = nullptr);
    ~StreamReader();
    
    // æµæ§åˆ¶
    bool startRead(const QString& deviceId);
    void stopRead();
    
signals:
    void dataReceived(const QByteArray& data);
    void readError(const QString& error);
    
private:
    void readLoop();
    
    QThread* m_readThread;
    bool m_isReading;
};
```

## ğŸ“± è®¾å¤‡æ¨¡å—

### è®¾å¤‡ç®¡ç†å™¨ (DeviceManager)
ç»Ÿä¸€ç®¡ç†æ‰€æœ‰è®¾å¤‡ï¼Œæä¾›è®¾å¤‡å‘ç°ã€è¿æ¥ã€ç®¡ç†ç­‰åŠŸèƒ½ã€‚

```cpp
class DeviceManager : public QObject
{
    Q_OBJECT

public:
    static DeviceManager* instance();
    
    // è®¾å¤‡ç®¡ç†
    QVector<DeviceInfo> devices() const;
    bool connectDevice(const QString& deviceId);
    void disconnectDevice(const QString& deviceId);
    
    // ç¼“å­˜ç®¡ç†
    void clearCache();
    
signals:
    void deviceDiscovered(const DeviceInfo& device);
    void deviceConnected(const QString& deviceId);
    void deviceDisconnected(const QString& deviceId);
    
private:
    void initializeDevices();
    void loadDeviceCache();
    
    QVector<DeviceInfo> m_deviceList;
    QHash<QString, Device*> m_connectedDevices;
    QVector<DeviceProxy*> m_proxies;
};
```

### è®¾å¤‡ä»£ç† (DeviceProxy)
æŠ½è±¡è®¾å¤‡æ¥å£ï¼Œæ”¯æŒä¸åŒå¹³å°çš„è®¾å¤‡å®ç°ã€‚

```cpp
class DeviceProxy : public QObject
{
    Q_OBJECT

public:
    virtual ~DeviceProxy() = default;
    
    // è®¾å¤‡æŸ¥è¯¢
    virtual QVector<DeviceInfo> queryDevices() = 0;
    
    // è®¾å¤‡è¿æ¥
    virtual bool setupDeviceServer(const QString& serial, int forwardPort) = 0;
    virtual bool startDeviceServer(const QString& serial) = 0;
    virtual void stopDeviceServer(const QString& serial) = 0;
    
    // è®¾å¤‡ç±»å‹
    virtual DeviceType deviceType() const = 0;
    
signals:
    void deviceFound(const DeviceInfo& device);
    void deviceLost(const QString& serial);
};
```

### Android è®¾å¤‡ (AndroidDevice)
Android è®¾å¤‡çš„å…·ä½“å®ç°ã€‚

```cpp
class AndroidDevice : public DeviceProxy
{
    Q_OBJECT

public:
    explicit AndroidDevice(QObject* parent = nullptr);
    
    // å®ç° DeviceProxy æ¥å£
    QVector<DeviceInfo> queryDevices() override;
    bool setupDeviceServer(const QString& serial, int forwardPort) override;
    bool startDeviceServer(const QString& serial) override;
    void stopDeviceServer(const QString& serial) override;
    DeviceType deviceType() const override { return DeviceType::Android; }
    
private:
    bool checkAdbAvailable();
    QString executeAdbCommand(const QStringList& args);
    
    QString m_adbPath;
};
```

### OpenHarmony è®¾å¤‡ (OHOSDevice)
OpenHarmony è®¾å¤‡çš„å…·ä½“å®ç°ã€‚

```cpp
class OHOSDevice : public DeviceProxy
{
    Q_OBJECT

public:
    explicit OHOSDevice(QObject* parent = nullptr);
    
    // å®ç° DeviceProxy æ¥å£
    QVector<DeviceInfo> queryDevices() override;
    bool setupDeviceServer(const QString& serial, int forwardPort) override;
    bool startDeviceServer(const QString& serial) override;
    void stopDeviceServer(const QString& serial) override;
    DeviceType deviceType() const override { return DeviceType::OHOS; }
    
private:
    bool checkHdcAvailable();
    QString executeHdcCommand(const QStringList& args);
    
    QString m_hdcPath;
};
```

## ğŸ–¥ï¸ ç•Œé¢æ¨¡å—

### ä¸»çª—å£ (MainWindow)
åº”ç”¨ç¨‹åºçš„ä¸»çª—å£ï¼Œæä¾›æ•´ä½“ç•Œé¢æ¡†æ¶ã€‚

```cpp
class MainWindow : public FramelessWindow
{
    Q_OBJECT

public:
    explicit MainWindow(QWidget* parent = nullptr);
    ~MainWindow();

private slots:
    void onDeviceSelected(const QString& deviceId);
    void onSettingsClicked();
    void onAboutClicked();
    
private:
    void setupUI();
    void setupConnections();
    
    TitleBar* m_titleBar;
    DeviceListPage* m_deviceListPage;
    StatusBar* m_statusBar;
};
```

### è®¾å¤‡åˆ—è¡¨é¡µé¢ (DeviceListPage)
æ˜¾ç¤ºå’Œç®¡ç†è®¾å¤‡åˆ—è¡¨çš„é¡µé¢ã€‚

```cpp
class DeviceListPage : public QWidget
{
    Q_OBJECT

public:
    explicit DeviceListPage(QWidget* parent = nullptr);

signals:
    void deviceSelected(const QString& deviceId);
    
private slots:
    void onDeviceDiscovered(const DeviceInfo& device);
    void onDeviceConnected(const QString& deviceId);
    void onDeviceDisconnected(const QString& deviceId);
    void onRefreshClicked();
    
private:
    void setupUI();
    void updateDeviceList();
    
    QVBoxLayout* m_layout;
    QListWidget* m_deviceList;
    QPushButton* m_refreshButton;
};
```

### æŠ•å±çª—å£ (ScreenWindow)
æ˜¾ç¤ºè®¾å¤‡æŠ•å±å†…å®¹çš„çª—å£ã€‚

```cpp
class ScreenWindow : public FramelessWindow
{
    Q_OBJECT

public:
    explicit ScreenWindow(const QString& deviceId, QWidget* parent = nullptr);
    ~ScreenWindow();

private slots:
    void onFrameReady(const QImage& frame);
    void onScreenshotClicked();
    void onFullscreenClicked();
    
private:
    void setupUI();
    void setupConnections();
    void handleMouseEvent(QMouseEvent* event);
    void handleKeyEvent(QKeyEvent* event);
    
    QString m_deviceId;
    QLabel* m_screenLabel;
    StreamDecoder* m_decoder;
    StreamReader* m_reader;
};
```

## ğŸ› ï¸ å·¥å…·æ¨¡å—

### æ—¥å¿—ç³»ç»Ÿ (Log)
æä¾›ç»Ÿä¸€çš„æ—¥å¿—è®°å½•å’Œç®¡ç†åŠŸèƒ½ã€‚

```cpp
class Log : public QObject
{
    Q_OBJECT

public:
    enum Level {
        Debug,
        Info,
        Warning,
        Error,
        Critical
    };
    
    static void debug(const QString& message);
    static void info(const QString& message);
    static void warning(const QString& message);
    static void error(const QString& message);
    static void critical(const QString& message);
    
private:
    static void writeLog(Level level, const QString& message);
    
    static QFile* m_logFile;
    static QMutex m_mutex;
};
```

### æ— è¾¹æ¡†çª—å£ (FramelessWindow)
æä¾›æ— è¾¹æ¡†çª—å£çš„åŸºç¡€åŠŸèƒ½ã€‚

```cpp
class FramelessWindow : public QWidget
{
    Q_OBJECT

public:
    explicit FramelessWindow(QWidget* parent = nullptr);

protected:
    bool nativeEvent(const QByteArray& eventType, void* message, long* result) override;
    void mousePressEvent(QMouseEvent* event) override;
    void mouseMoveEvent(QMouseEvent* event) override;
    void mouseReleaseEvent(QMouseEvent* event) override;
    
private:
    bool m_isResizing;
    QPoint m_lastPos;
    Qt::Edges m_resizeEdges;
};
```

## ğŸ”„ æ•°æ®æµ

### è®¾å¤‡å‘ç°æµç¨‹
```
1. åº”ç”¨å¯åŠ¨ â†’ DeviceManager åˆå§‹åŒ–
2. åŠ è½½è®¾å¤‡ä»£ç† â†’ AndroidDevice, OHOSDevice
3. å®šæœŸæŸ¥è¯¢è®¾å¤‡ â†’ queryDevices()
4. å‘ç°æ–°è®¾å¤‡ â†’ deviceDiscovered ä¿¡å·
5. æ›´æ–°è®¾å¤‡åˆ—è¡¨ â†’ DeviceListPage æ›´æ–°
```

### æŠ•å±è¿æ¥æµç¨‹
```
1. ç”¨æˆ·é€‰æ‹©è®¾å¤‡ â†’ deviceSelected ä¿¡å·
2. åˆ›å»ºè®¾å¤‡æœåŠ¡å™¨ â†’ setupDeviceServer()
3. å¯åŠ¨æµè¯»å–å™¨ â†’ StreamReader::startRead()
4. å¯åŠ¨æµè§£ç å™¨ â†’ StreamDecoder::startDecode()
5. æ˜¾ç¤ºæŠ•å±çª—å£ â†’ ScreenWindow æ˜¾ç¤º
6. å¤„ç†è§†é¢‘å¸§ â†’ frameReady ä¿¡å·
```

### æ•°æ®ä¼ é€’æµç¨‹
```
è®¾å¤‡ â†’ StreamReader â†’ StreamDecoder â†’ ScreenWindow
  â†“         â†“            â†“              â†“
åŸå§‹æ•°æ® â†’ å­—èŠ‚æ•°ç»„ â†’ QImage â†’ ç•Œé¢æ˜¾ç¤º
```

## ğŸ”§ æ‰©å±•æœºåˆ¶

### æ’ä»¶ç³»ç»Ÿ
é€šè¿‡æ’ä»¶ç³»ç»Ÿæ”¯æŒåŠŸèƒ½æ‰©å±•ï¼š

```cpp
class PluginInterface
{
public:
    virtual ~PluginInterface() = default;
    virtual QString name() const = 0;
    virtual QString version() const = 0;
    virtual bool initialize() = 0;
    virtual void cleanup() = 0;
};

Q_DECLARE_INTERFACE(PluginInterface, "com.screencast.PluginInterface")
```

### æ–°å¹³å°æ”¯æŒ
æ·»åŠ æ–°å¹³å°æ”¯æŒçš„æ­¥éª¤ï¼š

1. **å®ç° DeviceProxy æ¥å£**
2. **æ³¨å†Œåˆ° DeviceManager**
3. **æ·»åŠ å¹³å°ç±»å‹æšä¸¾**
4. **æ›´æ–°è®¾å¤‡è¯†åˆ«é€»è¾‘**

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### å†…å­˜ç®¡ç†
- **æ™ºèƒ½ç¼“å­˜**: ç¼“å­˜å¸¸ç”¨æ•°æ®å’Œå¯¹è±¡
- **åŠæ—¶é‡Šæ”¾**: åŠæ—¶é‡Šæ”¾ä¸å†ä½¿ç”¨çš„èµ„æº
- **å†…å­˜æ± **: ä½¿ç”¨å†…å­˜æ± å‡å°‘åˆ†é…å¼€é”€

### å¤šçº¿ç¨‹å¤„ç†
- **UI çº¿ç¨‹**: å¤„ç†ç•Œé¢æ›´æ–°å’Œç”¨æˆ·äº¤äº’
- **å·¥ä½œçº¿ç¨‹**: å¤„ç†è®¾å¤‡é€šä¿¡å’Œæ•°æ®è§£ç 
- **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨äº’æ–¥é”ä¿æŠ¤å…±äº«æ•°æ®

### ç½‘ç»œä¼˜åŒ–
- **è¿æ¥å¤ç”¨**: å¤ç”¨ç½‘ç»œè¿æ¥å‡å°‘å¼€é”€
- **æ•°æ®å‹ç¼©**: å‹ç¼©ä¼ è¾“æ•°æ®å‡å°‘å¸¦å®½
- **æµé‡æ§åˆ¶**: æ§åˆ¶æ•°æ®ä¼ è¾“é€Ÿç‡

---

**ScreenCast çš„æ¶æ„è®¾è®¡æ³¨é‡æ¨¡å—åŒ–ã€å¯æ‰©å±•æ€§å’Œé«˜æ€§èƒ½ï¼Œä¸ºé¡¹ç›®çš„é•¿æœŸå‘å±•å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚** 